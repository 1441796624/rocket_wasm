<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
  </head>

  <body>
    <h2>Rocket</h2>
    <canvas id="canvas" width="1024" height="600"></canvas>

<!-- bundle.js is fully stolen from hellorust.org -->
<script src="bundle.js"></script>
<script>
  // Canvas related stuff
  let canvas = document.getElementById('canvas');
  var ctx = canvas.getContext("2d");

  let env = {};
  env.clear_screen = () => {
    ctx.fillStyle = "black";
    ctx.fillRect(0, 0, canvas.width, canvas.height);
  }
  env.draw_player = (x, y, angle) => {
    ctx.fillStyle = "red";
    //ctx.translate(x, y);
    //ctx.rotate(angle);
    // Paths don't seem to work...
    /*
    ctx.beginPath();
    ctx.lineTo(100, 75);
    ctx.lineTo(100, 25);
    ctx.fill();
    ctx.closePath(); */
    ctx.fillRect(x, y, 20, 20);
    //ctx.setTransform(1, 0, 0, 1, 0, 0);
  }
  env.draw_enemy = (x, y) => {
    ctx.fillStyle = "yellow";
    ctx.fillRect(x - 10, y - 10, 20, 20);
  }
  env.draw_bullet = (x, y) => {
    ctx.fillStyle = "blue";
    ctx.fillRect(x, y, 10, 10);
  }
  env.draw_particle = (x, y, radius) => {
    let r = 2 * radius;
    ctx.fillStyle = "purple"
    ctx.fillRect(x - r, y - r, 2 * r, 2 * r);
    // Something goes wrong here...
    /*
    ctx.beginPath();
    ctx.arc(x, y, 2 * r, 0, 2 * Math.PI);
    ctx.fillStyle = 'purple';
    ctx.fill();
    ctx.closePath();
    */
  }

  // Wasm related stuff
  window.Module = {};

  // Terribly inefficient way of showing the dependencies
  fetch('program.wasm').then(response =>
    response.arrayBuffer()
    ).then(bytes =>
    WebAssembly.compile(bytes)
    ).then(function(mod) {
    var imports = WebAssembly.Module.imports(mod);
    imports.forEach(i => console.log(i));
    });

  // The real loading and running of our wasm starts here
  env.Math_atan = Math.atan;
  env.sin = Math.sin;
  env.cos = Math.cos;

  fetchAndInstantiate("program.wasm", { env })
    .then(mod => {
      Module.alloc = mod.exports.alloc;
      Module.dealloc = mod.exports.dealloc;
      Module.dealloc_str = mod.exports.dealloc_str;
      Module.update = mod.exports.update;
      Module.toggle_shoot = mod.exports.toggle_shoot;
      Module.toggle_boost = mod.exports.toggle_boost;
      Module.toggle_turn_left = mod.exports.toggle_turn_left;
      Module.toggle_turn_right = mod.exports.toggle_turn_right;
      Module.draw = mod.exports.draw;
      Module.memory  = mod.exports.memory;

      // Input processing
      function processKey(key, b) {
        switch (key) {
          case "ArrowLeft":
            Module.toggle_turn_left(b);
            break;
          case "ArrowRight":
            Module.toggle_turn_right(b);
            break;
          case "ArrowUp":
            Module.toggle_boost(b);
            break;
          case " ":
            Module.toggle_shoot(b);
            break;
        }
      }
      document.addEventListener('keydown', e => processKey(e.key, true));
      document.addEventListener('keyup', e => processKey(e.key, false));


      // Game loop
      let start = null;
      let prevTimestamp = null;
      let drawAndUpdate = (timestamp) => {
        if (!prevTimestamp) {
          start = timestamp;
          prevTimestamp = timestamp;

          // Request next frame
          requestAnimationFrame(drawAndUpdate);
          return;
        }

        if (timestamp - start > 5000) {
          return;
        }

        // Deal with time
        let progress = (timestamp - prevTimestamp) / 1000;
        prevTimestamp = timestamp;

        // Update
        Module.update(progress);

        // Draw
        Module.draw();

        // Request next frame
        requestAnimationFrame(drawAndUpdate);
      };

      drawAndUpdate();
    });
</script>
  </body>
</html>
